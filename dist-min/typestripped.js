export class ParseError extends Error{}function descr(e,t){e.toString=()=>"<"+t+">";return e}const e=descr(/(\s|\/\/.*|\/\*[\s\S]*?\*\/)+/y,"whitespace"),t=descr(/[a-zA-Z_$][0-9a-zA-Z_$]*/y,"identifier"),s=descr(/(['"])(?:(?=(\\?))\2.)*?\1/y,"string"),r=descr(/[+-]?(?:0[xX][0-9a-fA-F]+|0[oO][0-7]+|0[bB][01]+|\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)/y,"number"),a=descr(/instanceof\b|in\b|[!=]==|\|\|=?|>>=?|<<=?|&&=?|[+\-*\/%&|^!=<>]=|[+\-*\/%&|^=<>]/y,"bin-op"),u=descr(/[\s\S]*?(\${|`)/y,"`string`"),n=descr(/\+\+|--|!|~|\+|-|typeof\b|delete\b|await\b/y,"unary-op"),i=descr(/\/(\\.|[^\/])+\/[gimsuyd]*/y,"regexp"),p=/[\s\S]/y,f=/\S/g,l=/^[a-zA-Z0-9]+$/;export function typestripped(o,{debug:m,recover:c,transformImport:k}={}){let h=0;let E=1;let y=1;let g="";let x=0;let d=0;let b=0;let w=new Set;let T=true;let S=0;parseMain();return g;function parseMain(){eat(e);while(h<o.length)must(recoverErrors(parseStatement,true))}function parseStatement(){S=g.length;if(parseVarDecl()||parseTypeDecl()||parseBlock()||parseExport()||parseEnum()||parseClass()||parseReturn()||parseIfWhile()||parseThrow()||parseDoWhile()||parseFor()||parseImport()||parseTry()||parseDeclare()||parseSwitch()||parseExpressionStatement()||eat(";"))return true;return false}function parseExpressionStatement(){if(!parseExpressionSeq())return false;mustEos();return true}function parseExport(){if(!eat("export"))return false;if(eat("default")){must(parseExpression()||parseClass())}else{must(parseVarDecl()||parseTypeDecl()||parseClass()||parseExpression()||parseLiteralObject())}mustEos();return true}function parseVarDecl(){if(!eat("let")&&!eat("const")&&!eat("var"))return false;if(peek("enum")){console.error("Const enums are not supported");return parseEnum()}while(true){must(eat(t));if(skip(":")){must(skip(parseType))}if(eat("="))must(parseExpression);if(!eat(","))break}mustEos();return true}function parseTypeDecl(){if(!skip("type"))return false;wipeStatement();must(skip(t));skip(parseTemplateDef);if(skip("="))must(skip(parseType));mustEos();return true}function parseEnum(){let e=g.length;if(!eat("enum"))return false;let s=must(eat(t));must(eat("{"));replaceOutput(e,`var ${s} = (function (${s}) {`);let a=0,u=true;while(u){e=g.length;let n=eat(t);if(!n)break;if(eat("=")){a=parseInt(must(eat(r)))}if(!eat(","))u=false;replaceOutput(e,`${s}[(${s}["${n}"] = ${a++})] = "${n}";`)}e=g.length;must(eat("}"));replaceOutput(e,`return ${s};})(${s} || {});`);return true}function parseReturn(){if(!eat("return")&&!eat("yield"))return false;parseExpression();mustEos();return true}function parseIfWhile(){const e=eat("if")||eat("while");if(!e)return false;must(eat("("));must(parseExpression);must(eat(")"));must(parseStatement);if(e==="if"&&eat("else"))must(parseStatement);return true}function parseThrow(){if(!eat("throw"))return false;must(parseExpression);mustEos();return true}function parseDoWhile(){if(!eat("do"))return false;must(parseStatement);must(eat("while"));must(eat("("));must(parseExpression);must(eat(")"));mustEos();return true}function parseFor(){if(!eat("for"))return false;must(eat("("));if(eat("let")||eat("const")||eat("var")){must(eat(t));if(skip(":"))must(skip(parseType));if(eat("="))must(parseExpression)}else{parseExpressionSeq()}if(eat("of")||eat("in")){must(parseExpressionSeq())}else{must(eat(";"));parseExpressionSeq();must(eat(";"));parseExpressionSeq()}must(eat(")"));must(parseStatement);return true}function parseSwitch(){if(!eat("switch"))return false;must(eat("("));must(parseExpression);must(eat(")"));must(eat("{"));let e=false;while(!eat("}")){if(eat("case")&&must(parseExpression)||eat("default")){must(eat(":"));e=true}else{must(e&&recoverErrors(parseStatement))}}}function parseImport(){if(!eat("import"))return false;if(eat("*")){must(eat("as"));must(eat(t))}else{must(eat("{"));while(true){if(!eat(t))break;if(eat("as"))must(eat(t));if(!eat(","))break}must(eat("}"))}must(eat("from"));let e=g.length;must(eat(s));if(k){let t=g.substring(e+1,g.length-1);t=k(t);replaceOutput(e,'"'+t+'"')}mustEos();return true}function parseTry(){if(!eat("try"))return;must(parseBlock);if(eat("catch")){if(eat("(")){must(eat(t));if(skip(":"))must(skip(parseType));must(eat(")"))}must(parseBlock)}if(eat("finally"))must(parseBlock);return true}function parseDeclare(){if(!skip("declare"))return false;skip("enum");must(skip(t));must(skip(parseBlock));return true}function parseBlock(){if(!eat("{"))return false;while(!eat("}"))recoverErrors(parseStatement,true);return true}function parseTemplateDef(){if(skip("<")){while(true){must(skip(t));if(skip("extends"))must(skip(parseType));if(!skip(","))break}must(skip(">"));return true}return false}function parseFuncParams(e=false){let s="";if(!eat("("))return false;while(true){if(eat("..."))must(eat(t));else if(e&&(skip("public")||skip("private")||skip("protected"))){const e=must(eat(t));s+=`this.${e}=${e};`}else if(!eat(t))break;skip("?");if(skip(":"))must(skip(parseType));if(eat("="))must(parseExpression);if(!eat(","))break}must(eat(")"));return e&&s?s:true}function parseFunction(){if(!eat("async","function")&&!eat("function"))return false;eat(t);parseTemplateDef();must(parseFuncParams);if(skip(":"))must(skip(parseType));if(parseBlock())return true;mustEos();wipeStatement();return true}function parseArrowFunction(){if(!attempt((()=>{eat("async");parseTemplateDef();if(!parseFuncParams()&&!eat(t))return false;if(skip(":"))must(skip(parseType));if(!eat("=>"))return false;return true})))return false;must(parseBlock()||parseExpression());return true}function parseSequence(){if(!eat("("))return false;must(parseExpressionSeq);must(eat(")"));return true}function parseExpressionSeq(){if(!parseExpression())return false;while(eat(","))must(parseExpression);return true}function parseExpression(){let e=false;while(eat(n))e=true;if(eat("new"))e=true;if(eat(s)||parseBacktickString()||eat(r)||parseClass()||parseFunction()||parseArrowFunction()||parseSequence()||eat(t)||parseLiteralArray()||parseLiteralObject()||eat(i)){}else{if(e)must(false);return false}while(true){if(peek("("))parseCall();else if(peek("["))parseIndex();else if(eat("++")||eat("--")){}else if(skip("as"))must(skip(parseType));else if(eat("?."))must(eat(t)||parseIndex());else if(eat("."))must(eat(t));else if(peek("<")&&parseTemplateArg()){}else if(eat(a)){must(parseExpression);return true}else if(skip("!")){}else break}if(eat("?")){must(parseExpression);must(eat(":"));must(parseExpression)}return true}function parseBacktickString(){if(!eat("`"))return false;while(true){let e=must(eat(u));if(e.slice(-1)==="`")break;must(parseExpression);must(eat("}"))}return true}function parseLiteralArray(){if(!eat("["))return false;while(true){if(eat("..."))must(parseExpression);else parseExpression();if(!eat(","))break}must(eat("]"));return true}function parseLiteralObject(){if(!eat("{"))return false;while(true){if(eat("..."))must(parseExpression);else{eat("*");if(eat("[")){must(parseExpression);must(eat("]"))}else{if(!eat(t)&&!eat(r)&&!eat(s)&&!parseBacktickString)break}if(parseTemplateDef()&&must(parseFuncParams())||parseFuncParams()){if(skip(":")){skip(parseType)}must(parseBlock())}else{if(eat(":"))must(parseExpression)}if(!eat(","))break}}must(eat("}"));return true}function parseTemplateArg(){return attempt((()=>{if(!skip("<"))return false;must(skip(parseType));while(skip(","))must(skip(parseType));must(skip(">"));if(peek(".")||peek("(")||peek("{")||peek(";")||h>=o.length)return true;return false}))}function parseCall(){if(!eat("("))return false;while(true){if(eat("..."))must(parseExpression);else if(!parseExpression())break;if(!eat(","))break}must(eat(")"));return true}function parseIndex(){if(!eat("["))return false;must(parseExpressionSeq);must(eat("]"));return true}function parseType(e=true){let a=false;if(eat("typeof"))return must(parseExpression);if(eat("keyof"))a=true;if(eat(t)){if(eat("<")){must(parseType);while(eat(",")){must(parseType)}must(eat(">"))}}else if(eat("{")){while(true){if(eat("[")){must(eat(t));must(eat(":"));must(parseType);must(eat("]"))}else if(!eat(t)&&!eat(r)&&!eat(s))break;must(eat(":"));must(parseType);if(!eat(","))break}must(eat("}"))}else if(eat("[")){while(true){if(!parseType())break;if(!eat(","))break}must(eat("]"))}else if(e&&attempt(parseFuncParams)){must(eat("=>"));must(parseType);return true}else if(eat("(")){must(parseType);must(eat(")"))}else if(!eat(r)&&!eat(s)){if(a)must(false);return false}while(eat("[")){parseType();must(eat("]"))}while(true){if(eat("|")||eat("&")){must(parseType(false))}else{break}}if(eat("extends")){must(parseType);must(eat("?"));must(parseType);must(eat(":"));must(parseType)}return true}function parseClass(){let e=false;if(skip("abstract")){must(eat("class"))}else{if(skip("interface")){e=true;wipeStatement();x++}else if(!eat("class")){return false}}eat(t);parseTemplateDef();if(eat("extends"))must(parseExpression());while(skip("implements"))must(skip(parseType));must(eat("{"));while(!eat("}")){must(eat(";")||recoverErrors((()=>parseMethod(e)),true))}if(e)x--;return true}function parseMethod(e=false){S=g.length;e||(e=!!skip("abstract"));skip("public")||skip("private")||skip("protected");e||(e=!!skip("abstract"));peek("get",t)&&eat("get")||peek("set",t)&&eat("set");if(eat("static")){if(parseBlock())return true}eat("async");eat("*");const s=eat(t);if(!s){if(eat("[")){must(parseExpression);must(eat("]"))}else{if(g.length!==S){must(false)}return false}}if(!peek("<")&&!peek("(")){if(skip(":"))must(skip(parseType));if(eat("="))must(parseExpression);mustEos();return true}skip(parseTemplateDef);let r=must(parseFuncParams(s==="constructor"));if(skip(":"))must(skip(parseType));if(e||!eat("{")){mustEos();wipeStatement();return true}if(typeof r!=="string"){while(!eat("}"))must(recoverErrors(parseStatement));return true}if(attempt((()=>{replaceOutput(g.length,r);while(!eat("}")){if(peek("super","("))return false;must(recoverErrors(parseStatement))}return true})))return true;while(!eat("}")){let e=peek("super","(");must(recoverErrors(parseStatement));if(e)replaceOutput(g.length,r)}return true}function replaceOutput(e,t){let s=g.substring(e);let r=s.split("\n");let a=r.length-1;let u=t.split("\n").length-1;if(u>a)throw new Error("Invalid replaceOutput");g=g.substring(0,e)+t;g+="\n".repeat(a-u);let n=r[r.length-1];if(n.trim()==="")g+=n;if(m)debugLog("replace output",toJson(s),"by",toJson(g.substr(e)))}function must(e){if(typeof e==="function")e=e();if(e)return e;let t=(new Error).stack||"";let s=/\bat parse([A-Z][a-zA-Z]*)/.exec(t)||["","top-level"];let r=[];let a=[];for(let e of w){if(e instanceof ParseError)a.push(e.message);else if(e instanceof Array)r.push(joinTokens(e," + "));else r.push(e)}let u=new ParseError(`Could not parse ${s[1]} at ${E}:${y}, got ${toJson(o.substr(h,24))}, expected one of:   ${joinTokens(r,"   ")}`);if(a.length)u.attempts=a;throw u}function recoverErrors(r,a=false){if(b||!c)return r();let u=h;try{const e=r();if(a&&u===h)must(false);return e}catch(r){if(!(r instanceof ParseError))throw r;console.error(r);console.error("Attempting to recover...");while(h<o.length&&!eat(";")&&!eat("}")){must(eat(e)||eat(t)||eat(s)||eat(p));if(T)break}return h>u}}function attempt(e){let t={pos:h,line:E,col:y,out:g,matchOptions:w};w=new Set;b++;try{let s=e();if(s)return s;if(h===t.pos&&g===t.out)return false;must(false)}catch(e){if(!(e instanceof ParseError))throw e;t.matchOptions.add(e)}finally{b--}h=t.pos;E=t.line;y=t.col;g=t.out;if(m)debugLog("reverted attempt");w=t.matchOptions;return false}function wipeStatement(){const e=g.substr(S);const t=e.replace(f," ");if(e!==t){if(m)debugLog("wipe output",toJson(e));g=g.substr(0,S)+t}}function mustEos(){if(h>=o.length)return true;if(eat(";"))return true;if(T)return true;if(peek("}"))return true;must(false);return false}function skip(...e){x++;const t=e.length===1&&typeof e[0]==="function"?e[0]():eat(...e);x--;return t}function peek(...e){d++;const t=eat(...e);d--;return t}function eat(...t){let s=h;let r;let a=false;for(let u of t){r=undefined;if(typeof u==="string"){if(o.substr(h,u.length)===u&&(!u.slice(-1).match(l)||!o.substr(h+u.length,1).match(l)))r=u}else{u.lastIndex=h;const e=u.exec(o);if(e)r=e[0]}if(r===undefined){h=s;w.add(t.length==1?t[0]:t);return}h+=r.length;e.lastIndex=h;let n=(e.exec(o)||[""])[0];h+=n.length;a=n.indexOf("\n")>=0}if(d){h=s;return r}const u=o.substring(s,h);w.clear();T=a;if(m)debugLog(x?"skip":"eat",toJson(u),"as",joinTokens(t," + "));const n=u.lastIndexOf("\n");if(n>=0){E+=u.split("\n").length-1;y=u.length-n}else{y+=u.length}if(x)g+=u.replace(f," ");else g+=u;return r}function getParseStack(){let e=Array(...((new Error).stack||"").matchAll(/\bat parse([A-Z][a-zA-Z]+).*?(:\d+)/g)||[]).map((e=>e[1]+e[2]));return e.join(" <- ")}function debugLog(...e){(typeof m==="function"?m:console.debug)(E+":"+y,...e,"parsing",getParseStack())}}function toJson(e){return JSON.stringify(e)}function joinTokens(e,t){return e.map((e=>typeof e==="string"?toJson(e):e.toString())).toSorted().join(t)}